# 开发文档

## 创意来源

《三国杀》是一款生生不息，历久弥新的桌游，已有十五年历史，成为不少人年轻时代难忘的回忆，不少人都是因为一张张的杀闪而相遇、相知、相识在一起，凝结着共同美好的过去。但是由于现在快节奏的生活，高强度的学习工作压力，很难再像以前一样一桌人凑在一起在杀闪纵横中谈笑，所以我开发了这款人机1V1三国杀，并对武将技能及卡牌构成进行了平衡性调整。

## 实现思路

### 交互功能

采用 `EasyX` 提供的图形库来实现按钮，按键检测，界面跳转，绘图，音乐等功能，在图鉴功能中主要采用鼠标点击交互功能，在正式游戏中主要采用键盘交互。

### 图鉴功能

#### 武将

从标准包中选取24名武将，对其技能进行了一定的平衡性调整，使其武将技能能适应 `1V1` 的环境，对每名武将展示图片，修改后的技能，以及随机台词。

#### 卡牌

从三国杀军争牌堆的160张中选择一些，加入了 `水淹七军` ，共52张牌构成 `1V1` 牌库，点数为 `1~13` ，花色为黑桃、红桃、梅花、方片，对于每张卡牌展示图片，在牌堆中的数目，使用效果。

### 回合控制

每次界面依次执行判定、摸牌、出牌、弃牌阶段，执行后更新当前阶段状态，在回合结束时重置状态，并且将回合换为对方回合，重复上述流程。

### 技能控制

#### 主动技能

* 限一次技能：例如 `孙权` 的 `制衡` ，出牌阶段按下 `W` 键即可进入 `制衡` 提示界面，按下相应键即可发动技能，发动后则本回合不会再检测此技能；
* 无次数限制技能：例如 `大乔` 的 `国色` ，出牌阶段按下 `W` 键即可进入 `国色` 提示界面，按下相应键即可发动技能，且发动一次后，仍可再次发动（存在其他角色判定区不存在 `乐不思蜀` ）。

#### 被动技能

* 增益效果技能：例如 `周瑜` 的 `英姿` ，在摸牌阶段会自动检测并发动；
* 限制效果技能：例如 `陆逊` 的 `谦逊` ，对手在使用 `顺手牵羊` 时即不能选择 `陆逊` 作为目标。

装备的实现思路与武器相同，在此不再赘述。

### 电脑逻辑

利用多年玩三国杀的经验积累，作为每张牌的基础评分，结合场面局势给出估价函数，评价每张牌在当前状态下的优劣，执行当前更优的操作。

## 数据结构设计

### 卡牌

卡牌采用自定义 `struct Kapai` ，包含卡牌名称，点数，花色，类型等信息，鉴于卡牌使用有主观上的优先级，因此根据其重要程度进行了重载运算符操作。

### 牌堆

牌堆采用`Class Paidui` ，主要元素为 `std::vector<Kapai>` ，实现了获取牌堆顶的牌并删除之，加入一张牌，打乱顺序等函数。

### 武将

武将采用 `Class GameObejct` ，包含武将名称，手牌，武器，防具，生命值，生命上限等信息，其中手牌采用 `std::multiset<Kapai>` 存储，实现了使用和打出手牌、恢复和扣减体力、发动技能等函数。

另外交互界面涉及到的 `Class Button` 与 `Class Application` 较为大众化，这里同样不再赘述。

## 文件模块设计

主要包括四个文件夹

* inc：存储所有 `.h` 文件
* lib：存储所有 `.dll` ， `.lib` 文件
* res：存储所有 `.png` ， `.mp3`文件
* src：存储所有 `.cpp` 文件

## 运行环境

已将所有使用到外部链接库打包在安装包中，安装包程序在Windows下安装后均可使用

## 技术细节

游戏过程的技术细节在之前的实现思路与数据结构设计中已有体现，以下主要为交互中的技术细节，：

* 交互检测采用循环，每次需要重新 `PeekMouseMessage` 来刷新才可实时检测；
* 按键按下是一个时间段，在此期间可能会多次检测，因此在检测后需进行按键的释放；
* 为了展示的流畅性，采用了 `BeginBatchDraw()` 函数，在每次绘制后需及时 `FlushBatchDraw()` 以实时更新；
* 背景音乐和台词、音效等同时播放采用 `Fmod` 模块实现
* 使用 `magick` 工具制作图标；
* 使用 `Inno Setup Compiler` 工具进行打包。

## 体会

1. 写总体代码量较大的工程，应提前构思好每个基础数据结构所包含的变量及相应操作，否则使用时缺少再添加浪费时间并且难以修改；
2. 基础技能树需要先点好再上，否则遇到一个学一个容易形成递归学习，效率低下且不成体系；
3. 写软件是一个系统性的工程，不仅仅涉及到算法问题，还涉及到更多操作，比如各种库的调用，在此过程中我对增进了C++中类和继承概念的理解，初识面向对象的程序设计思想；
4. 需要用到多元的知识，例如使用其他程序来批量编写相似变量的定义及运算，使用Python爬取所需配音文件并剪辑等。

